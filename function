var SHEET_NAME = "PropertyAPI";
var HEADERS = [
  "Region",
  "Title",
  "StreetAddress",
  "Suburb",
  "Postcode",
  "DisplayPrice",
  "PriceRange",
  "PropertyType",
  "Bedrooms",
  "Bathrooms",
  "CarSpaces",
  "Features",
  "LandSize",
  "Description",
  "ListingID",
  "AgencyListingID",
  "AgencyName",
  "AgencyEmail",
  "Inspection1",
  "Inspection2",
  "Inspection3",
  "ModifiedDate",
  "Link"
];

var DEFAULT_QUERY = {
  pageSize: 500,
  maxPrice: 950000,
  minBedrooms: 3
};

var REGIONS = [
  "region:Brisbane - Greater Region, QLD",
  "region:Brisbane - Southern Region, QLD",
  "region:Brisbane - Western Region, QLD"
];

var EXCLUDED_PROPERTY_TYPES = {
  "retirement living": true,
  "residential land": true
};

function pullAllRegions() {
  var props = PropertiesService.getScriptProperties();
  var apiKey = props.getProperty("rapidAPI.key");
  var apiHost = props.getProperty("rapidAPI.host");
  var baseUrl = props.getProperty("baseUrl");

  var sheet = ensureSheet_(SHEET_NAME);
  sheet.clear();
  sheet.getRange(1, 1, 1, HEADERS.length).setValues([HEADERS]);

  var allResults = [];

  REGIONS.forEach(function(region) {
    var listings = fetchRegionListings_(region, baseUrl, apiKey, apiHost);

    if (!listings.length) {
      Logger.log("No data returned for " + region);
      return;
    }

    var keptCount = 0;

    listings.forEach(function(listing) {
      if (isExcludedPropertyType_(listing.propertyType)) {
        return;
      }

      allResults.push(toSheetRow_(listing, region));
      keptCount++;
    });

    Logger.log(region + " returned " + listings.length + " listings, kept " + keptCount);
  });

  if (allResults.length > 0) {
    sheet.getRange(2, 1, allResults.length, HEADERS.length).setValues(allResults);
  }

  Logger.log("Loaded " + allResults.length + " properties.");
}

function ensureSheet_(sheetName) {
  var spreadsheet = SpreadsheetApp.getActive();
  var sheet = spreadsheet.getSheetByName(sheetName);
  return sheet || spreadsheet.insertSheet(sheetName);
}

function fetchRegionListings_(region, baseUrl, apiKey, apiHost) {
  var queryParams = Object.keys(DEFAULT_QUERY).map(function(key) {
    return key + "=" + encodeURIComponent(DEFAULT_QUERY[key]);
  });

  queryParams.unshift("locationId=" + encodeURIComponent(region));

  var url = baseUrl + "?" + queryParams.join("&");
  var options = {
    method: "GET",
    headers: {
      "X-RapidAPI-Key": apiKey,
      "X-RapidAPI-Host": apiHost
    }
  };

  var response = UrlFetchApp.fetch(url, options);
  var status = response.getResponseCode();

  if (status !== 200) {
    Logger.log("Error for region " + region + ": HTTP " + status);
    return [];
  }

  var json;

  try {
    json = JSON.parse(response.getContentText());
  } catch (e) {
    Logger.log("JSON parse failed for region " + region);
    return [];
  }

  return Array.isArray(json.data) ? json.data : [];
}

function isExcludedPropertyType_(propertyType) {
  var normalizedType = (propertyType || "").toLowerCase();
  return !!EXCLUDED_PROPERTY_TYPES[normalizedType];
}

function toSheetRow_(listing, region) {
  var address = listing.address || {};
  var price = listing.price || {};
  var advertising = listing.advertising || {};
  var generalFeatures = (listing.features || {}).general || {};
  var agency = listing.agency || {};

  var featureList = flattenPropertyFeatures_(listing.propertyFeatures);
  var inspections = getUpcomingInspections_(listing.inspectionsAndAuctions);

  return [
    region,
    listing.title || "",
    address.streetAddress || "",
    address.locality || "",
    address.postcode || "",
    price.display || "",
    advertising.priceRange || "",
    listing.propertyType || "",
    generalFeatures.bedrooms || "",
    generalFeatures.bathrooms || "",
    generalFeatures.parkingSpaces || "",
    featureList.join(", "),
    (listing.landSize || {}).value || "",
    listing.description || "",
    listing.listingId || "",
    listing.agencyListingId || "",
    agency.name || "",
    agency.email || "",
    inspections[0],
    inspections[1],
    inspections[2],
    listing.modifiedDate ? new Date(listing.modifiedDate) : "",
    (((listing._links || {}).prettyUrl) || {}).href || ""
  ];
}

function flattenPropertyFeatures_(propertyFeatures) {
  if (!Array.isArray(propertyFeatures)) {
    return [];
  }

  return propertyFeatures.reduce(function(accumulator, group) {
    if (Array.isArray(group.features)) {
      return accumulator.concat(group.features);
    }

    return accumulator;
  }, []);
}

function getUpcomingInspections_(inspectionsAndAuctions) {
  var inspections = (inspectionsAndAuctions || [])
    .filter(function(item) {
      return item.auction === false && item.startTime;
    })
    .sort(function(a, b) {
      return new Date(a.startTime) - new Date(b.startTime);
    })
    .slice(0, 3)
    .map(function(item) {
      return new Date(item.startTime);
    });

  while (inspections.length < 3) {
    inspections.push("");
  }

  return inspections;
}
